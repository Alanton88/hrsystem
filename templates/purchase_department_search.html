{% extends "base.html" %}

{% block title %}依請購部門搜尋{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header text-center">
                <h2 class="fw-bold mb-0">
                    <i class="fas fa-building me-2"></i>依請購部門搜尋
                </h2>
                <p class="mb-0 mt-2 opacity-75">請選擇請購部門進行搜尋</p>
            </div>
            <div class="card-body py-4">
                <!-- 搜尋表單 -->
                <form id="purchaseDepartmentSearchForm">
                    <div class="row justify-content-center">
                        <div class="col-md-10">
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <label for="department" class="form-label fw-bold fs-5">
                                        <i class="fas fa-building me-2"></i>請購部門
                                    </label>
                                    <select class="form-select form-select-lg" 
                                            id="department" 
                                            name="department" 
                                            required>
                                        <option value="">請選擇請購部門</option>
                                        <option value="製造部">製造部</option>
                                        <option value="研發部">研發部</option>
                                        <option value="總務部">總務部</option>
                                        <option value="人資部">人資部</option>
                                        <option value="財務部">財務部</option>
                                        <option value="業務部">業務部</option>
                                        <option value="品保部">品保部</option>
                                        <option value="倉儲部">倉儲部</option>
                                    </select>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        選擇要搜尋的請購部門
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg me-3">
                                    <i class="fas fa-search me-2"></i>搜尋
                                </button>
                                <a href="{{ url_for('purchase_search') }}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-arrow-left me-2"></i>返回搜尋選單
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- 搜尋結果區域 -->
                <div id="searchResultsContainer" class="mt-5" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>搜尋結果
                            </h5>
                            <span id="resultCount" class="badge bg-primary fs-6"></span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>請購單號</th>
                                            <th>請購日期</th>
                                            <th>請購部門</th>
                                            <th>申請人</th>
                                            <th>品名</th>
                                            <th>規格</th>
                                            <th>數量</th>
                                            <th>單位</th>
                                            <th>請購單簽核</th>
                                            <th>驗收單驗收狀態</th>
                                            <th>驗收單簽核狀態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="searchResults">
                                        <!-- 動態載入搜尋結果 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 無結果提示 -->
                <div id="noResultsContainer" class="mt-5" style="display: none;">
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-search fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">沒有找到符合條件的請購單</h5>
                            <p class="text-muted">請檢查選擇的部門是否正確，或嘗試選擇其他部門</p>
                            <button class="btn btn-outline-primary" onclick="clearSearch()">
                                <i class="fas fa-redo me-2"></i>重新搜尋
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 請購單詳細資料模態框 -->
<div class="modal fade" id="purchaseDetailModal" tabindex="-1" aria-labelledby="purchaseDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="purchaseDetailModalLabel">
                    <i class="fas fa-file-alt me-2"></i>請購單詳細資料
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="purchaseDetailContent">
                <!-- 動態載入請購單詳細資料 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>關閉
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
.form-select-lg {
    font-size: 1.1rem;
    padding: 0.75rem 1rem;
}

.btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
}

.search-result-item {
    border: 1px solid #e9ecef;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.search-result-item:hover {
    border-color: #0d6efd;
    box-shadow: 0 5px 15px rgba(13, 110, 253, 0.1);
    transform: translateY(-2px);
}

.status-badge {
    font-size: 0.9em;
    padding: 0.4rem 0.8rem;
}

.purchase-no {
    font-weight: bold;
    color: #0d6efd;
    font-size: 1.1em;
}

.detail-row {
    margin-bottom: 0.75rem;
}

.detail-label {
    font-weight: 600;
    color: #495057;
    min-width: 120px;
    display: inline-block;
}

.detail-value {
    color: #212529;
}

.card-header {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    color: white;
}

.modal-header {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    color: white;
}

.btn-close {
    filter: invert(1);
}

/* 下拉選單樣式 */
.form-select {
    border-radius: 10px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.form-select option {
    padding: 8px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// 等待 DOM 載入完成
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM 載入完成，設置部門搜尋事件監聽器');
    
    // 處理搜尋表單提交
    const form = document.getElementById('purchaseDepartmentSearchForm');
    if (form) {
        console.log('找到部門搜尋表單元素，設置事件監聽器');
        form.addEventListener('submit', function(e) {
            console.log('部門搜尋表單提交事件觸發');
            e.preventDefault();
            
            const department = document.getElementById('department').value;
            
            console.log('選擇的部門:', department);
            
            if (!department) {
                alert('請選擇請購部門');
                return;
            }
            
            // 顯示載入狀態
            showLoading();
            
            // 發送搜尋請求
            fetch('/search-purchase-requests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    search_type: 'department',
                    department: department
                })
            })
            .then(response => {
                console.log('API響應狀態:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API響應數據:', data);
                hideLoading();
                if (data.success) {
                    displaySearchResults(data.results);
                } else {
                    alert('搜尋失敗: ' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('搜尋錯誤:', error);
                alert('搜尋過程中發生錯誤');
            });
        });
    } else {
        console.error('找不到部門搜尋表單元素');
    }
});

function showLoading() {
    // 隱藏之前的結果
    document.getElementById('searchResultsContainer').style.display = 'none';
    document.getElementById('noResultsContainer').style.display = 'none';
    
    // 顯示載入提示
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
            <p class="text-muted">正在搜尋請購單...</p>
        </div>
    `;
    document.getElementById('searchResultsContainer').style.display = 'block';
}

function hideLoading() {
    // 載入完成，結果會由 displaySearchResults 處理
}

function displaySearchResults(results) {
    const resultsContainer = document.getElementById('searchResults');
    const resultCount = document.getElementById('resultCount');
    
    if (results.length === 0) {
        // 顯示無結果
        document.getElementById('searchResultsContainer').style.display = 'none';
        document.getElementById('noResultsContainer').style.display = 'block';
    } else {
        // 顯示搜尋結果
        document.getElementById('searchResultsContainer').style.display = 'block';
        document.getElementById('noResultsContainer').style.display = 'none';
        
        let resultsHTML = '';
        results.forEach(result => {
            const approvalStatusClass = getStatusClass(result.簽核);
            const receiptStatusClass = getReceiptStatusClass(result.驗收狀態);
            const receiptApprovalClass = getReceiptApprovalClass(result.驗收單簽核狀態);
            
            resultsHTML += `
                <tr>
                    <td class="purchase-no fw-bold">${result.請購單號 || 'N/A'}</td>
                    <td>${result.請購日期 ? result.請購日期.replace(/-/g, '').replace(/\//g, '') : 'N/A'}</td>
                    <td>${result.請購部門 || 'N/A'}</td>
                    <td>${result.申請人 || 'N/A'}</td>
                    <td>${result.品名 || 'N/A'}</td>
                    <td>${result.規格 || 'N/A'}</td>
                    <td>${result.數量 || 'N/A'}</td>
                    <td>${result.單位 || 'N/A'}</td>
                    <td><span class="badge ${approvalStatusClass}">${result.簽核 || '待簽核'}</span></td>
                    <td><span class="badge ${receiptStatusClass}">${result.驗收狀態 || '待驗收'}</span></td>
                    <td><span class="badge ${receiptApprovalClass}">${result.驗收單簽核狀態 || '待簽核'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewPurchaseDetail('${result.請購單號}')" title="查看詳情">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        resultsContainer.innerHTML = resultsHTML;
    }
    
    resultCount.textContent = `${results.length} 筆結果`;
}

function getStatusClass(status) {
    switch(status) {
        case '核准':
            return 'bg-success';
        case '駁回':
            return 'bg-danger';
        case '待簽核':
        default:
            return 'bg-warning';
    }
}

function getReceiptStatusClass(status) {
    switch(status) {
        case '已驗收':
            return 'bg-success';
        case '驗收中':
            return 'bg-info';
        case '待驗收':
        default:
            return 'bg-warning';
    }
}

function getReceiptApprovalClass(status) {
    switch(status) {
        case '核准':
            return 'bg-success';
        case '駁回':
            return 'bg-danger';
        case '待簽核':
        default:
            return 'bg-warning';
    }
}

function viewPurchaseDetail(purchaseNo) {
    // 顯示載入狀態
    const modalContent = document.getElementById('purchaseDetailContent');
    modalContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
            <p class="mt-2">正在載入請購單詳細資料...</p>
        </div>
    `;
    
    // 顯示模態框
    const modal = new bootstrap.Modal(document.getElementById('purchaseDetailModal'));
    modal.show();
    
    // 取得詳細資料
    fetch(`/purchase-detail/${purchaseNo}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPurchaseDetail(data.data);
            } else {
                modalContent.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>取得請購單詳細資料失敗: ${data.message}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('取得請購單詳細資料錯誤:', error);
            modalContent.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>取得請購單詳細資料過程中發生錯誤</p>
                </div>
            `;
        });
}

function displayPurchaseDetail(purchase) {
    const modalContent = document.getElementById('purchaseDetailContent');
    
    const detailHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="detail-row">
                    <span class="detail-label">請購單號:</span>
                    <span class="fw-bold text-primary">${purchase.請購單號 || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">請購日期:</span>
                    <span>${purchase.請購日期 ? purchase.請購日期.replace(/-/g, '').replace(/\//g, '') : 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">請購部門:</span>
                    <span>${purchase.請購部門 || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">申請人:</span>
                    <span>${purchase.申請人 || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span>${purchase.mail || 'N/A'}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="detail-row">
                    <span class="detail-label">品名:</span>
                    <span>${purchase.品名 || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">規格:</span>
                    <span>${purchase.規格 || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">數量:</span>
                    <span>${purchase.數量 || 'N/A'} ${purchase.單位 || ''}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">需求日期:</span>
                    <span>${purchase.需求日期 ? purchase.需求日期.replace(/-/g, '').replace(/\//g, '') : 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">簽核狀態:</span>
                    <span class="badge ${getStatusClass(purchase.簽核)}">${purchase.簽核 || '待簽核'}</span>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <div class="detail-row">
                    <span class="detail-label">用途:</span>
                    <span>${purchase.用途 || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">備註:</span>
                    <span>${purchase.備註 || 'N/A'}</span>
                </div>
                ${purchase.駁回原因說明 ? `
                <div class="detail-row">
                    <span class="detail-label">請購單駁回原因:</span>
                    <span class="text-danger">${purchase.駁回原因說明}</span>
                </div>
                ` : ''}
                ${purchase.上傳附件 ? `
                <div class="detail-row">
                    <span class="detail-label">附件:</span>
                    <a href="${purchase.上傳附件}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-paperclip me-1"></i>查看附件
                    </a>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    modalContent.innerHTML = detailHTML;
}

function clearSearch() {
    // 清空搜尋欄位
    document.getElementById('department').value = '';
    
    // 隱藏結果區域
    document.getElementById('searchResultsContainer').style.display = 'none';
    document.getElementById('noResultsContainer').style.display = 'none';
    
    // 聚焦到搜尋欄位
    document.getElementById('department').focus();
}

// 頁面載入時聚焦到搜尋欄位
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('department').focus();
});
</script>
{% endblock %} 